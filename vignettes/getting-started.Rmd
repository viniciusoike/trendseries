---
title: "Getting Started with trendseries"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with trendseries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 4.5
)
```

```{r setup, message=FALSE}
library(trendseries)
library(dplyr)
library(ggplot2)
```

## What is trendseries?

The `trendseries` package helps you extract trends from economic time series data. Think of trends as the underlying direction of your data, stripped of short-term fluctuations and noise.

This vignette will walk you through the basics, starting with the simplest possible example and gradually building up to more complex analyses.

## Your First Trend Analysis

Let's start with the simplest possible example: extracting a trend from Brazilian GDP construction data.

```{r first-trend}
# Load the data
data("gdp_construction", package = "trendseries")

# Take a quick look
head(gdp_construction)
```

This dataset contains quarterly observations of Brazil's construction sector GDP. Let's extract a trend using the Hodrick-Prescott (HP) filter, one of the most common methods in economics:

```{r hp-basic}
# Extract trend using HP filter
gdp_with_trend <- gdp_construction |>
  augment_trends(
    value_col = "gdp_construction",
    methods = "hp"
  )

# View the result
head(gdp_with_trend)
```

That's it! The `augment_trends()` function added a new column called `trend_hp` to your data. The original data stays intact, and you get a new column with the trend.

## Visualizing Your First Trend

Let's see what this trend looks like:

```{r plot-first-trend}
# Prepare data for plotting
plot_data <- gdp_with_trend |>
  select(date, gdp_construction, trend_hp) |>
  tidyr::pivot_longer(
    cols = c(gdp_construction, trend_hp),
    names_to = "series",
    values_to = "value"
  ) |>
  mutate(
    series = case_when(
      series == "gdp_construction" ~ "Original Data",
      series == "trend_hp" ~ "HP Filter Trend"
    )
  )

# Create the plot
ggplot(plot_data, aes(x = date, y = value, color = series)) +
  geom_line(linewidth = 0.8) +
  labs(
    title = "Brazil GDP Construction: Original vs Trend",
    x = "Date",
    y = "Construction Index",
    color = NULL
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Notice how the trend (in blue/teal) smooths out the short-term fluctuations in the original data. This makes it easier to see the long-term direction of the construction sector.

## Trying Different Trend Methods

The HP filter is just one way to extract trends. Let's compare it with two other popular methods:

- **HP filter**: Standard choice in macroeconomics
- **LOESS**: Local polynomial smoothing
- **Moving Average (MA)**: Simple average of nearby points

```{r compare-methods}
# Extract multiple trends at once
gdp_comparison <- gdp_construction |>
  augment_trends(
    value_col = "gdp_construction",
    methods = c("hp", "loess", "ma")
  )

# View the first few rows
gdp_comparison |>
  select(date, gdp_construction, starts_with("trend_")) |>
  head()
```

Now let's visualize all three methods:

```{r plot-comparison}
# Prepare data for plotting
comparison_plot <- gdp_comparison |>
  select(date, gdp_construction, starts_with("trend_")) |>
  tidyr::pivot_longer(
    cols = c(gdp_construction, starts_with("trend_")),
    names_to = "method",
    values_to = "value"
  ) |>
  mutate(
    method = case_when(
      method == "gdp_construction" ~ "Original",
      method == "trend_hp" ~ "HP Filter",
      method == "trend_loess" ~ "LOESS",
      method == "trend_ma" ~ "Moving Average"
    )
  )

# Plot
ggplot(comparison_plot, aes(x = date, y = value, color = method)) +
  geom_line(linewidth = 0.8) +
  labs(
    title = "Comparing Different Trend Extraction Methods",
    subtitle = "Same data, different methods",
    x = "Date",
    y = "Construction Index",
    color = "Method"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Each method produces a slightly different trend. The HP filter and LOESS are quite similar, while the moving average is slightly more responsive to changes in the data.

## Working with Monthly Data

So far we've used quarterly data (4 observations per year). Let's try monthly data, which is more common in economic analysis.

```{r monthly-data}
# Load monthly vehicle production data
data("vehicles", package = "trendseries")

# Look at recent data (last 4 years)
recent_vehicles <- vehicles |>
  slice_tail(n = 48)

head(recent_vehicles)
```

The process is exactly the same - `augment_trends()` automatically detects the frequency:

```{r monthly-trend}
# Extract trend from monthly data
vehicles_with_trend <- recent_vehicles |>
  augment_trends(
    value_col = "vehicles",
    methods = "hp"
  )

# Visualize
vehicles_with_trend |>
  select(date, vehicles, trend_hp) |>
  tidyr::pivot_longer(
    cols = c(vehicles, trend_hp),
    names_to = "series",
    values_to = "value"
  ) |>
  mutate(
    series = ifelse(series == "vehicles", "Original", "HP Trend")
  ) |>
  ggplot(aes(x = date, y = value, color = series)) +
  geom_line(linewidth = 0.8) +
  labs(
    title = "Brazil Vehicle Production: Monthly Data",
    subtitle = "Last 4 years of data",
    x = "Date",
    y = "Production (thousands of units)",
    color = NULL
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Understanding Parameters: Window and Smoothing

Different trend methods accept different parameters. The `trendseries` package simplifies this with two main parameters:

- **`window`**: Controls the period for moving averages (e.g., 12 months)
- **`smoothing`**: Controls how smooth the trend should be

Let's experiment with the `window` parameter for a moving average:

```{r window-param}
# Try different window sizes
vehicles_windows <- recent_vehicles |>
  augment_trends(
    value_col = "vehicles",
    methods = "ma",
    window = 6
  ) |>
  rename(trend_ma_6m = trend_ma)

# Add 12-month window
vehicles_windows <- vehicles_windows |>
  augment_trends(
    value_col = "vehicles",
    methods = "ma",
    window = 12
  )

# Visualize
vehicles_windows |>
  select(date, vehicles, trend_ma_6m, trend_ma) |>
  tidyr::pivot_longer(
    cols = c(vehicles, trend_ma_6m, trend_ma),
    names_to = "method",
    values_to = "value"
  ) |>
  mutate(
    method = case_when(
      method == "vehicles" ~ "Original",
      method == "trend_ma_6m" ~ "6-month MA",
      method == "trend_ma" ~ "12-month MA"
    )
  ) |>
  ggplot(aes(x = date, y = value, color = method)) +
  geom_line(linewidth = 0.8) +
  labs(
    title = "Window Size Comparison",
    subtitle = "Larger windows = smoother trends",
    x = "Date",
    y = "Production (thousands)",
    color = NULL
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

**Key insight**: Larger windows produce smoother trends but are slower to react to changes. Smaller windows track the data more closely but may still include some noise.

For monthly data:
- Short-term trend: `window = 3` to `6`
- Medium-term trend: `window = 12` (one year)
- Long-term trend: `window = 24` or more

## Working with Multiple Economic Indicators

A common task is comparing trends across different economic indicators. Let's look at economic activity and vehicle production together:

```{r multi-series}
# Load IBC-Br (economic activity index)
data("ibcbr", package = "trendseries")

# Get recent data for both series
recent_ibcbr <- ibcbr |>
  slice_tail(n = 48) |>
  augment_trends(value_col = "ibcbr", methods = "hp")

recent_vehicles_hp <- recent_vehicles |>
  augment_trends(value_col = "vehicles", methods = "hp")

# Normalize to Jan 2020 = 100 for comparison
normalize_series <- function(data, value_col, trend_col) {
  base_value <- data[[value_col]][1]
  base_trend <- data[[trend_col]][1]

  data |>
    mutate(
      value_normalized = .data[[value_col]] / base_value * 100,
      trend_normalized = .data[[trend_col]] / base_trend * 100
    )
}

# Prepare comparison data
comparison_data <- bind_rows(
  recent_ibcbr |>
    normalize_series("ibcbr", "trend_hp") |>
    mutate(indicator = "Economic Activity (IBC-Br)") |>
    select(date, indicator, value_normalized, trend_normalized),

  recent_vehicles_hp |>
    normalize_series("vehicles", "trend_hp") |>
    mutate(indicator = "Vehicle Production") |>
    select(date, indicator, value_normalized, trend_normalized)
)

# Plot trends only
comparison_data |>
  ggplot(aes(x = date, y = trend_normalized, color = indicator)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Economic Indicators: HP Filter Trends",
    subtitle = "Normalized to first observation = 100",
    x = "Date",
    y = "Index (normalized)",
    color = "Indicator"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

This shows both series moved together during the pandemic period but diverged afterwards, with economic activity recovering more strongly than vehicle production.

## Available Trend Methods

The `trendseries` package supports many trend extraction methods. Here are the most commonly used:

### Economic/Econometric Filters
- **`hp`**: Hodrick-Prescott filter (default, widely used in macroeconomics)
- **`bk`**: Baxter-King bandpass filter (isolates business cycles)
- **`cf`**: Christiano-Fitzgerald filter (asymmetric bandpass)
- **`hamilton`**: Hamilton regression filter (recent alternative to HP)

### Moving Averages
- **`ma`**: Simple moving average (easiest to understand)
- **`ewma`**: Exponentially weighted moving average (more weight on recent data)
- **`wma`**: Weighted moving average (emphasizes recent observations)
- **`zlema`**: Zero-lag exponential moving average (reduced lag)
- **`triangular`**: Triangular moving average (double-smoothed)

### Smoothing Methods
- **`loess`**: Local polynomial regression (flexible, data-adaptive)
- **`spline`**: Smoothing splines (very smooth)
- **`stl`**: Seasonal-trend decomposition (handles seasonality)

### Advanced Methods
- **`sg`**: Savitzky-Golay filter (preserves features like peaks)
- **`kalman`**: Kalman smoother (optimal under certain assumptions)
- **`kernel`**: Kernel regression smoother (nonparametric)

**Recommendation for beginners**: Start with `hp` for general use, `ma` when you want something simple and interpretable, and `stl` when your data has clear seasonal patterns.

## Quick Reference: Common Patterns

Here are some ready-to-use patterns for common scenarios:

### Basic trend extraction
```{r eval=FALSE}
# Single method, quarterly data
data |>
  augment_trends(value_col = "your_column", methods = "hp")

# Single method, monthly data
data |>
  augment_trends(value_col = "your_column", methods = "hp")
```

### Compare multiple methods
```{r eval=FALSE}
data |>
  augment_trends(
    value_col = "your_column",
    methods = c("hp", "loess", "ma")
  )
```

### Control smoothness
```{r eval=FALSE}
# Smoother HP filter (higher lambda)
data |>
  augment_trends(
    value_col = "your_column",
    methods = "hp",
    smoothing = 3200  # vs default 1600 for quarterly
  )

# Longer moving average window
data |>
  augment_trends(
    value_col = "your_column",
    methods = "ma",
    window = 24  # 2-year window for monthly data
  )
```

### Grouped data
```{r eval=FALSE}
# Apply trend to multiple series at once
multi_series_data |>
  group_by(country) |>
  augment_trends(value_col = "gdp", methods = "hp") |>
  ungroup()
```

## Next Steps

Now that you understand the basics, you can:

1. **Explore specific methods in depth**: Check out the "Moving Averages" vignette for detailed analysis of MA methods
2. **Learn about economic filters**: See the "Economic Filters" vignette for HP, BK, and CF filters
3. **Try advanced methods**: Explore STL decomposition, Kalman filtering, and more in the "Advanced Methods" vignette
4. **Read the function documentation**: `?augment_trends` and `?extract_trends`

## Built-in Datasets

The package includes several economic datasets for practice:

### Brazilian Economic Data (Monthly)
- **`ibcbr`**: Central Bank Economic Activity Index - smooth, good for learning
- **`vehicles`**: Vehicle production - cyclical, interesting patterns
- **`electric`**: Electricity consumption - seasonal patterns
- **`oil_derivatives`**: Oil derivatives production

### Brazilian Economic Data (Quarterly)
- **`gdp_construction`**: GDP construction index - smooth, great for first examples

### International Data
- **`retail_households`**: UK household goods retail (monthly)
- **`retail_autofuel`**: UK automotive fuel retail (monthly)
- **`coffee_arabica`**: Coffee prices (daily, advanced)
- **`coffee_robusta`**: Coffee prices (daily, advanced)

**Tip**: Start with `gdp_construction` (quarterly) or `ibcbr` (monthly) - they're both relatively smooth and easy to interpret.

## Getting Help

If you run into issues:

- Check the documentation: `?augment_trends`
- View examples: `example(augment_trends)`
- Read other vignettes: `vignette(package = "trendseries")`
- Report bugs: GitHub issues

Happy trend extraction!

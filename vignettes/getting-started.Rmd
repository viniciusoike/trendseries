---
title: "Getting Started with trendseries"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with trendseries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r setup}
library(trendseries)
library(dplyr)
library(ggplot2)

# Load package data
data("series_metadata", "gdp_construction", "ibcbr", "electric",
     "vehicles", "oil_derivatives", package = "trendseries")
```

## Introduction

The `trendseries` package provides a simplified, unified interface for extracting trends from economic time series data. It offers:

- **Unified parameter system**: Use `window`, `smoothing`, and `band` parameters across multiple methods
- **Pipe-friendly workflow**: Seamlessly integrate with `dplyr` and `tidyverse` workflows
- **Economic focus**: Optimized for monthly and quarterly economic data
- **Multiple methods**: 22+ trend extraction methods from simple moving averages to advanced filters

## Package Datasets

The package includes several Brazilian economic indicators and international data:

```{r show-metadata}
# View metadata for all BCB series
series_metadata
```

All BCB series use a simplified format with just `date` and the series value:

```{r data-structure}
# Example: Central Bank Economic Activity Index
head(ibcbr)

# Example: Vehicle production data
head(vehicles)
```

## Basic Usage

### Single Trend Method

The simplest way to extract a trend is using `augment_trends()` with a single method:

```{r basic-hp}
# HP filter on quarterly GDP construction data
gdp_with_trend <- gdp_construction |>
  augment_trends(value_col = "gdp_construction", methods = "hp")

head(gdp_with_trend)
```

### Multiple Methods at Once

You can extract multiple trends simultaneously:

```{r multiple-methods}
# Compare different smoothing approaches on GDP construction
gdp_comparison <- gdp_construction |>
  augment_trends(
    value_col = "gdp_construction",
    methods = c("hp", "loess", "ma"),
    smoothing = 0.3,  # Applied to hp and loess
    window = 8        # Applied to ma
  )

# View the result
gdp_comparison |>
  select(date, gdp_construction, starts_with("trend_")) |>
  head()
```

## Unified Parameter System

Instead of remembering method-specific parameter names, `trendseries` uses three unified parameters:

- **`window`**: For moving average methods (ma, alma, dema, hma, stl, sg)
- **`smoothing`**: For smoothing methods (hp, loess, spline, exponential smoothing, etc.)
- **`band`**: For bandpass filters (bk, cf, butter) as `c(low, high)`

```{r unified-params}
# Demonstrate unified parameters on electric consumption
electric_trends <- electric |>
  slice_head(n = 100) |>  # Use subset for faster processing
  augment_trends(
    value_col = "electric",
    methods = c("ma", "loess", "bk"),
    window = 12,           # 12-month moving average
    smoothing = 0.5,       # Loess span
    band = c(6, 32)        # BK bandpass filter (6-32 months)
  )

electric_trends |>
  select(date, electric, starts_with("trend_")) |>
  head()
```

## Working with Different Data Types

### Quarterly Data

```{r quarterly-data}
# GDP construction data (quarterly frequency = 4)
gdp_trends <- gdp_construction |>
  augment_trends(
    value_col = "gdp_construction",
    methods = c("hp", "stl", "poly"),
    smoothing = 1600  # Standard HP lambda for quarterly data
  )

# Plot the results
gdp_trends |>
  select(date, gdp_construction, trend_hp, trend_stl) |>
  tidyr::pivot_longer(cols = c(gdp_construction, trend_hp, trend_stl),
                      names_to = "series", values_to = "value") |>
  ggplot(aes(x = date, y = value, color = series)) +
  geom_line() +
  labs(title = "Brazil GDP Construction: Original vs HP and STL Trends",
       x = "Date", y = "Construction Index") +
  theme_minimal()
```

### Monthly Data with Seasonality

```{r monthly-seasonal}
# Electricity consumption (monthly data with potential seasonality)
electric_seasonal <- electric |>
  slice_tail(n = 60) |>  # Last 5 years
  augment_trends(
    value_col = "electric",
    methods = c("stl", "hp", "ma"),
    window = 12  # 12-month centered moving average
  )

# Plot seasonally-adjusted vs raw data
electric_seasonal |>
  select(date, electric, trend_stl, trend_hp) |>
  tidyr::pivot_longer(cols = c(electric, trend_stl, trend_hp),
                      names_to = "series", values_to = "value") |>
  ggplot(aes(x = date, y = value, color = series)) +
  geom_line() +
  labs(title = "Electricity Consumption: Raw vs Trends",
       x = "Date", y = "Consumption (GWh)") +
  theme_minimal()
```

### Industrial Production Analysis

```{r industrial-data}
# Compare vehicle production and oil derivatives production
vehicles_trends <- vehicles |>
  slice_tail(n = 48) |>  # Last 4 years
  augment_trends(
    value_col = "vehicles",
    methods = c("ewma", "hp", "loess"),
    smoothing = 0.3
  )

# Visualization
vehicles_trends |>
  select(date, vehicles, trend_ewma, trend_hp) |>
  tidyr::pivot_longer(cols = c(vehicles, trend_ewma, trend_hp),
                      names_to = "series", values_to = "value") |>
  ggplot(aes(x = date, y = value, color = series)) +
  geom_line() +
  labs(title = "Vehicle Production: Raw vs Trends",
       x = "Date", y = "Production (thousands of units)") +
  theme_minimal()
```

## Advanced Usage

### Fine-tuning with the `params` Argument

For advanced users, the `params` argument allows fine-tuning of method-specific parameters:

```{r advanced-params}
# Advanced parameter tuning on Central Bank Activity Index
ibcbr_advanced <- ibcbr |>
  slice_tail(n = 48) |>  # Last 4 years
  augment_trends(
    value_col = "ibcbr",
    methods = c("sg", "wavelet", "poly"),
    window = 9,  # Savitzky-Golay window
    params = list(
      sg_poly_order = 3,      # Higher polynomial order
      wavelet_type = "db4",   # Daubechies 4 wavelet
      poly_degree = 2         # Quadratic polynomial
    )
  )

ibcbr_advanced |>
  select(date, ibcbr, starts_with("trend_")) |>
  head()
```

### Working with Time Series Objects Directly

You can also work directly with time series objects using `extract_trends()`:

```{r ts-objects}
# Convert to time series first (specify value column)
vehicles_ts <- df_to_ts(vehicles, value_col = "vehicles", frequency = 12)

# Extract multiple trends
vehicle_trends <- extract_trends(
  vehicles_ts,
  methods = c("hp", "loess", "ewma"),
  smoothing = 0.2
)

# vehicle_trends is a list of time series objects
str(vehicle_trends)
```

## Comparing Multiple Economic Indicators

```{r multi-series}
# Compare trends across different economic indicators
# Note: Using normalized data for comparison

# Normalize each series to 2020 = 100 for comparison
normalize_to_base <- function(data, date_col, value_col, base_year = 2020) {
  base_value <- data |>
    filter(lubridate::year({{ date_col }}) == base_year) |>
    summarise(base = mean({{ value_col }}, na.rm = TRUE)) |>
    pull(base)

  data |>
    mutate({{ value_col }} := {{ value_col }} / base_value * 100)
}

# Create comparison dataset
comparison_data <- bind_rows(
  ibcbr |> slice_tail(n = 60) |> normalize_to_base(date, ibcbr) |>
    mutate(series = "Economic Activity"),
  vehicles |> slice_tail(n = 60) |> normalize_to_base(date, vehicles) |>
    rename(ibcbr = vehicles) |> mutate(series = "Vehicle Production"),
  electric |> slice_tail(n = 60) |> normalize_to_base(date, electric) |>
    rename(ibcbr = electric) |> mutate(series = "Electric Consumption")
)

# Apply HP filter to all series
comparison_trends <- comparison_data |>
  group_by(series) |>
  augment_trends(value_col = "ibcbr", methods = "hp",
                 frequency = 12, smoothing = 14400) |>  # Monthly HP lambda
  ungroup()

# Plot comparison
comparison_trends |>
  ggplot(aes(x = date, y = trend_hp, color = series)) +
  geom_line(size = 1) +
  labs(title = "Economic Indicators: HP Filter Trends (2020 = 100)",
       x = "Date", y = "Index (2020 = 100)",
       color = "Indicator") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Available Methods

The package supports 22+ trend extraction methods:

### Economic/Econometric Filters
- **hp**: Hodrick-Prescott filter
- **bk**: Baxter-King bandpass filter
- **cf**: Christiano-Fitzgerald filter
- **hamilton**: Hamilton regression filter
- **bn**: Beveridge-Nelson decomposition
- **ucm**: Unobserved Components Model

### Moving Averages
- **ma**: Simple moving average
- **ewma**: Exponentially weighted moving average
- **alma**: Adaptive Linear Moving Average
- **dema**: Double Exponential Moving Average
- **hma**: Hull Moving Average

### Smoothing Methods
- **loess**: Local polynomial regression
- **spline**: Smoothing splines
- **stl**: Seasonal-trend decomposition
- **exp_simple/exp_double**: Exponential smoothing

### Advanced Methods
- **sg**: Savitzky-Golay filter
- **kernel**: Kernel regression smoother
- **butter**: Butterworth filter
- **kalman**: Kalman smoother
- **wavelet**: Wavelet denoising

## Next Steps

- Explore the **moving averages vignette** for detailed analysis of MA methods
- Check out the documentation for each method: `?extract_trends`
- Learn about advanced parameter tuning with `?augment_trends`
- Try different combinations of methods on your own economic time series data

## Package Data Summary

The package includes example datasets optimized for trend analysis:

### Brazilian Economic Data (BCB)
- `gdp_construction`: Quarterly GDP construction index
- `ibcbr`: Monthly economic activity index
- `electric`: Monthly electricity consumption
- `vehicles`: Monthly vehicle production
- `oil_derivatives`: Monthly oil derivatives production
- `series_metadata`: Comprehensive metadata for all series

### International Data
- `retail_households`: UK household goods retail sales
- `retail_autofuel`: UK automotive fuel retail sales
- `coffee_arabica`: Daily CEPEA Arabica coffee prices
- `coffee_robusta`: Daily CEPEA Robusta coffee prices

Each dataset demonstrates different characteristics useful for trend analysis (smooth trends, seasonality, cyclical patterns, etc.).